{"componentChunkName":"component---src-templates-blog-template-blog-template-tsx","path":"/blog/2019-11-22-all-about-tsung/","result":{"data":{"markdownRemark":{"html":"<p>In one of the class I took in UCLA this quarter,\nwe had to use <a href=\"http://tsung.erlang-projects.org/user_manual/index.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Tsung</a>\nas a load testing tool to load test our web application.\nWe first deploy our app on AWS. Then, we obtain another\nAWS instance to run the Tsung test script. The problem\nwith that set up is that debugging the test script is\nchallenging, since we cannot change our web app to\noutput debug information easily, and Tsung is not\neasy to debug as well. Therefore, I set it up locally\nto have it working. </p>\n<p>Other than the difficulty of debugging, the other\nchallenge that I ran into is to upload an image with\nTsung. In our web application, we used <code class=\"language-text\">multipart/form-data</code>\nto upload the image.</p>\n<p>In this article, I will describe how I set up Tsung\non my local (macOS), and how I used <code class=\"language-text\">tsung-recorder</code> to work\nwith image upload. </p>\n<ul>\n<li><a href=\"#installing-tsung\">Installing Tsung</a></li>\n<li><a href=\"#configuring-test-xml-script\">Configuring Test XML Script</a></li>\n<li><a href=\"#problem-with-multipartform-data\">Problem with <code class=\"language-text\">multipart/form-data</code></a></li>\n<li>\n<p><a href=\"#tsung-proxy-recorder\">Tsung Proxy Recorder</a></p>\n<ul>\n<li><a href=\"#what-is-a-proxy\">What Is A Proxy?</a></li>\n<li><a href=\"#using-tsung-recorder\">Using Tsung Recorder</a></li>\n<li><a href=\"#configure-macos-to-use-proxy\">Configure macOS to Use Proxy</a></li>\n<li><a href=\"#bypassing-chromes-localhost-no-proxy-policy\">Bypassing Chrome’s <code class=\"language-text\">localhost</code> No Proxy Policy</a></li>\n</ul>\n</li>\n<li><a href=\"#gotchas-in-test-script\">Gotchas in Test Script</a></li>\n</ul>\n<h2 id=\"installing-tsung\" style=\"position:relative;\"><a href=\"#installing-tsung\" aria-label=\"installing tsung permalink\" class=\"gatsby-remark-autolink-headers-a-tags before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Installing Tsung</h2>\n<p>We can install Tsung using homebrew. </p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">brew install tsung</code></pre></div>\n<p>This is going to install <code class=\"language-text\">tsung</code>  and <code class=\"language-text\">tsung-recorder</code>.\nThen, we are good to go.</p>\n<h2 id=\"configuring-test-xml-script\" style=\"position:relative;\"><a href=\"#configuring-test-xml-script\" aria-label=\"configuring test xml script permalink\" class=\"gatsby-remark-autolink-headers-a-tags before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Configuring Test XML Script</h2>\n<p>Since all the set up is done locally, our app server\nwill be on the same machine as our tsung test.\nFor this to work, we want to set our test script\nto hit our application at <code class=\"language-text\">localhost</code>. </p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token comment\">&lt;!-- Server side setup --></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>servers</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>server</span> <span class=\"token attr-name\">host</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>localhost<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">port</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>3000<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>tcp<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>server</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>servers</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>Here, my web app server is set up on <code class=\"language-text\">localhost:3000</code>. </p>\n<h2 id=\"problem-with-multipartform-data\" style=\"position:relative;\"><a href=\"#problem-with-multipartform-data\" aria-label=\"problem with multipartform data permalink\" class=\"gatsby-remark-autolink-headers-a-tags before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Problem with <code class=\"language-text\">multipart/form-data</code></h2>\n<p>Back when our app was simple enough, all the POST\nendpoint only contains textual data.\nTherefore, we can use <code class=\"language-text\">x-www-form-urlencoded</code> to\nsend our data. In Chrome DevTools, you can view\nthe raw HTTP body that is being sent to the server.\nFor instance,</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 640px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a6230e392c4e751d0bc1c93130523661/5c263/dev-tool-x-www-form.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.12500000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABLUlEQVQoz52SW4+CMBCF+f//zweNN6ClQG9QkIuCZ2e6xo0vanaSkw5D+7Wd0yTLcui6hlQVcqXhvIdzDlrXcbTWRjVNg8vlgr7v3yqRskDXdSiUgiwU5T2GYcQ4TuhoAn8vywKO+/2OT5EcTyl62rmqSmw2G6SnLVRZUm3Auq643ZYn6CvgdreH9028Ui4ErNFoQ4A2FuM0YZ5nTDQynIGflOz2BxhaXHMfpYQQEoGA1+s1gqYHcCHgSgsY/E4RyEYYY2LzPeXjOOC/kewPRwQyhUGCDKr4pGSOc57a0NLJNYx1D5Hj5HxFtVqbqCr+t885yTnNopsMPdMTSjOBjK7N0EKVyHIRZWky95Y3YXlS24bfWvvISREYQvfi4p+b37v74jL38NPCbxxm/QD4igWFJNfAogAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Chrome DevTool showing submitted form data in a POST request\"\n        title=\"Chrome DevTool showing submitted form data in a POST request\"\n        src=\"/static/a6230e392c4e751d0bc1c93130523661/6af66/dev-tool-x-www-form.png\"\n        srcset=\"/static/a6230e392c4e751d0bc1c93130523661/69538/dev-tool-x-www-form.png 160w,\n/static/a6230e392c4e751d0bc1c93130523661/72799/dev-tool-x-www-form.png 320w,\n/static/a6230e392c4e751d0bc1c93130523661/6af66/dev-tool-x-www-form.png 640w,\n/static/a6230e392c4e751d0bc1c93130523661/d9199/dev-tool-x-www-form.png 960w,\n/static/a6230e392c4e751d0bc1c93130523661/21b4d/dev-tool-x-www-form.png 1280w,\n/static/a6230e392c4e751d0bc1c93130523661/5c263/dev-tool-x-www-form.png 1636w\"\n        sizes=\"(max-width: 640px) 100vw, 640px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>If so, we can simply copy the content of the\nform data from the DevTool, and paste them into the\ntest script in the XML.</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>http</span> <span class=\"token attr-name\">url</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">'</span>/signup<span class=\"token punctuation\">'</span></span> <span class=\"token attr-name\">version</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">'</span>1.1<span class=\"token punctuation\">'</span></span>  <span class=\"token attr-name\">contents</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">'</span>user%5Bname%5D=test_name<span class=\"token entity\" title=\"&amp;\">&amp;amp;</span>user%5Bemail%5D=test%40gmail.com<span class=\"token entity\" title=\"&amp;\">&amp;amp;</span>user%5Bpassword%5D=fdsafdsa<span class=\"token entity\" title=\"&amp;\">&amp;amp;</span>user%5Bpassword_confirmation%5D=fdsafdsa<span class=\"token entity\" title=\"&amp;\">&amp;amp;</span>commit=Create+my+account<span class=\"token punctuation\">'</span></span>  <span class=\"token attr-name\">method</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">'</span>POST<span class=\"token punctuation\">'</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>http</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p><code class=\"language-text\">x-www-form-urlencoded</code> does not support\nraw binary file upload. We want to use <code class=\"language-text\">multipart/form-data</code>\ninstead. When I upload a form without an image,\nwe can see it in the DevTool.</p>\n<p><img src=\"/e3cdb6497f5849b0b89a7f286e829bcc/form-data-yes.gif\" alt=\"a multipart/form-data upload shown in POST request in Chrome DevTools\"></p>\n<p>You can still copy and paste the content by clicking\non <code class=\"language-text\">view source</code> and put them into the XML.\nHowever, <code class=\"language-text\">multipart/form-data</code> requires the body to\nuse CRLF line ending. Simple copy and paste might use\njust LF as line ending and might not work. </p>\n<p>However, the bigger problem is that when we select\na file to upload, we cannot see the raw output from the\nDevTool. </p>\n<p><img src=\"/9350d4db2a1c288fc8b5b6c7ff943067/form-data-no.gif\" alt=\"a multipart/form-data upload not shown in Chrome DevTools\"></p>\n<p>This make sense from the perspective of the user experience\nof Chrome DevTools. Showing the binary is going make the UI\nslow and displaying the binary is not useful to the users as\nwell. </p>\n<p>Since we cannot simply copy and paste from the DevTools,\nwe need another solution.</p>\n<h2 id=\"tsung-proxy-recorder\" style=\"position:relative;\"><a href=\"#tsung-proxy-recorder\" aria-label=\"tsung proxy recorder permalink\" class=\"gatsby-remark-autolink-headers-a-tags before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tsung Proxy Recorder</h2>\n<p>Tsung is aware that manually capturing the network\ntransaction and turning them into XML is a lot of\nmanual labor. Therefore, they provide a proxy recorder\nto simplify the process called <code class=\"language-text\">tsung-recorder</code>.</p>\n<h3 id=\"what-is-a-proxy\" style=\"position:relative;\"><a href=\"#what-is-a-proxy\" aria-label=\"what is a proxy permalink\" class=\"gatsby-remark-autolink-headers-a-tags before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What Is A Proxy?</h3>\n<p>Before we start using <code class=\"language-text\">tsung-recorder</code>, we need\nto understand what a proxy is. </p>\n<p>A proxy is simply a “man-in-the-middle”. If you\nuse a proxy service, all the network traffic will\nbe forwarded to the proxy server. The proxy server will\nhandle all the network traffic for you and return the\nappropriate response.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 640px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/81052dbea48a010e001afc266cec112e/39f45/proxy-comic.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 68.12499999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABYlAAAWJQFJUiTwAAACAUlEQVQ4y21USU5CQRDlgB7BDTfxBCbGC7hgw4qwICEEt6KBKENAhoTPTJjn+X+e9Vrq26iVNP27q/vVq6rXBHCx8/msn9jtdlgul1iv11itVmZN8zzP7NG32WzMN316l3PABuM8mUzgOA7K5TKq1aoZg8HAgCwWCzNzr1arYT6f++A+IH900NrtNlqtFnq9HjqdDpxGwwTYCJvRaISGrHmmXq8b0G63i9PpdM3wd8pMpd/vYzabmeie5eOawfb7PWzT+wGbHes1Ho/NTNDj8Yj94YCeMHZeXjCRIGsBPMk+2WazWaTTaVOSq5QVLJPJoFAooFQqaVh4MtVDIfSDQVQeH8HTrqTIGheLRUSjUeRyOZ+pD8iCp1Ipcyifz8N13e+Oy/h8eEDp9hbZuzu4cp6+j/d3QyAej2M4HP4wpBRobEQikUA4HEYsFsN2u/UZFp6eELu5wdv9/XcdpRzPySQikQhCwp5N+pMyi12pVEwXp9MpNBBtIE14ldSG0lG7OVTBQWqsZ68AadQgm0F2pjEX8S7leyUCnkrXuU8wKoDBtTR+l3VhAzMqQRmA8vAZyMyXQRAV+R9AG4yXqTHWhIJlSpQRQexnR6FTpywN91STVynrBWqKkiAo5aPi5msgK2qz2Wwan5bHNPC/t8xLPEQQvlMCcK1+lkJFr38eNjvaF1EgJaEkx3z/AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"A comic showing proxy\"\n        title=\"A comic showing proxy\"\n        src=\"/static/81052dbea48a010e001afc266cec112e/6af66/proxy-comic.png\"\n        srcset=\"/static/81052dbea48a010e001afc266cec112e/69538/proxy-comic.png 160w,\n/static/81052dbea48a010e001afc266cec112e/72799/proxy-comic.png 320w,\n/static/81052dbea48a010e001afc266cec112e/6af66/proxy-comic.png 640w,\n/static/81052dbea48a010e001afc266cec112e/d9199/proxy-comic.png 960w,\n/static/81052dbea48a010e001afc266cec112e/21b4d/proxy-comic.png 1280w,\n/static/81052dbea48a010e001afc266cec112e/39f45/proxy-comic.png 2184w\"\n        sizes=\"(max-width: 640px) 100vw, 640px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<blockquote>\n<p>From: <a href=\"https://en.wikipedia.org/wiki/Proxy_server\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://en.wikipedia.org/wiki/Proxy_server</a></p>\n</blockquote>\n<h3 id=\"using-tsung-recorder\" style=\"position:relative;\"><a href=\"#using-tsung-recorder\" aria-label=\"using tsung recorder permalink\" class=\"gatsby-remark-autolink-headers-a-tags before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Using Tsung Recorder</h3>\n<p>Tsung recorder is a special proxy server that captures all\nyour network traffic and record them in the format of XML\nthat can be executed by tsung as a test script. </p>\n<p>To start the test script, we use </p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">tsung-recorder start</code></pre></div>\n<p>Now, a proxy server is set up and listening traffic from\nthe port 8090 (default).\nAnd the recorded XML file can be found in <code class=\"language-text\">~/.tsung</code> (default).</p>\n<p>Just a side note, to shut down the proxy server and\nstop recording, technically you use </p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">tsung-recorder stop</code></pre></div>\n<p>However, on macOS, <code class=\"language-text\">tsung-recorder</code> for some reason cannot\nsee the other <code class=\"language-text\">tsung-recorder</code> process and shut them down.\nThe only way that I was able to shut them down is by\nlooking for the PID and use <code class=\"language-text\">kill</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ps aux | grep tsung</code></pre></div>\n<h3 id=\"configure-macos-to-use-proxy\" style=\"position:relative;\"><a href=\"#configure-macos-to-use-proxy\" aria-label=\"configure macos to use proxy permalink\" class=\"gatsby-remark-autolink-headers-a-tags before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Configure macOS to Use Proxy</h3>\n<p>Now we know have the proxy server set up. We configure\nour system to forward its traffic to the proxy server.\nThe setting of proxy can be found at\n<em>System Preferences > Networks > Advanced > Proxies</em>.</p>\n<p>We want to configure the Web Proxy to talk to server\nat <code class=\"language-text\">localhost:8090</code>.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 640px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3021b490286a3098deaef8062e509d77/78612/proxy-setting.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 76.875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAACcklEQVQ4y6VTy47TQBDM53LkB+CA+AHOiAMHLmi5IcEJkHhssrvKruM4D7/tGTt+xY6zTnYFh6J7ZidaccVSqd32TE11dc9oLRu4YYJMCmy3W1R1jbppUFNsKDL4u4m3uxrHfY2u5bw9rTEYibyAkBnKssRms6GPW8hM53meoyhKSCkp1+s+Tg948+2Amd9ApiHtKVBVFa3TccTKgsCH7/vwCEEYwfN8uK6LMAwh0lT/8zysVmt8uYzwaSIxXyeIowBJkiKlNXEcIyMhIyEknKWPubOCZS8VZoS169OJDURWwXEc2LatDtnIGAOV3W61JUmSIIoiRcqVjNJUwI72mPpb/LRSjJ0cPyyJ73aBidthGgxUQYjZbKZUJLSR85BIOOcqWL0mJIVFLvH2a43nZwVefhB4cSbw7L3Ek9cenr4r8OozqUxjzOcOLMtSKlkRkzIhN4+bJYTQCpNUomn3OPQNcirnbugB/HkAsL+9IxURIVBKePP9/T2Ox6PCMAw4HA7KP12yyLCp9+RHrZrC3e37HgMt4qdsj6QoflAVqNLMZga/8zScPJSSkk2PMCmwcBP4cY6s6JBXPfrhN9LiFuwzl2Q8Y2IGvzOiBz8VIc+P5wf4Nb7AeHKF8cUVzieXOKfcsh04ixUWiwWWy+WJ6DEMIUMR8jBrdkHypTZXsCI9WzwWvMk04F+YG8RlK0L2gM3932e32ykxI2bmk7gR/FGjQ9nsUFT6TvOV4maZ2LYtuq47gfdwpUqh7pBQXTLgubNWAuPpAtbNFDc3lhrs6+trBfaOLTA4NYWvHp9qoHw55aUCK3qszkRey6q4qeyhiX8BaU1LTKAVHXoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Proxy setting on macOS\"\n        title=\"Proxy setting on macOS\"\n        src=\"/static/3021b490286a3098deaef8062e509d77/6af66/proxy-setting.png\"\n        srcset=\"/static/3021b490286a3098deaef8062e509d77/69538/proxy-setting.png 160w,\n/static/3021b490286a3098deaef8062e509d77/72799/proxy-setting.png 320w,\n/static/3021b490286a3098deaef8062e509d77/6af66/proxy-setting.png 640w,\n/static/3021b490286a3098deaef8062e509d77/d9199/proxy-setting.png 960w,\n/static/3021b490286a3098deaef8062e509d77/78612/proxy-setting.png 1260w\"\n        sizes=\"(max-width: 640px) 100vw, 640px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<blockquote>\n<p>Do not forget to hit apply after changing the proxy\nsetting.</p>\n</blockquote>\n<p>Now, if you go to the browser, and navigate to pages\nthat uses <code class=\"language-text\">http</code>. You should be able to see the traffic\nbeing recorded in the file\n<code class=\"language-text\">~/.tsung/tsung_recorderXXXXXXXX-XXX.xml</code>. </p>\n<p>Note, if you navigate to pages that uses <code class=\"language-text\">https</code>, the\ntraffic cannot be recorded. Can you think of why a\nsimple HTTP proxy server cannot use HTTPS? </p>\n<details>\n<summary>\nClick to see why\n</summary>\n<p>For HTTPS, the traffic is completely encrypted, including the\nheader, which contains essential information for the proxy\nto forward the request from and to the client.</p>\n<p>There is HTTPS proxy, but <code class=\"language-text\">tsung-recorder</code> is not one of them.</p>\n</details>\n<p>Now, you are very excited to hit the endpoint on\n<code class=\"language-text\">localhost:3000</code> in your browser, and have tsung-recorder\nto record your complex multipart form POST request.\nBut you soon realize that it does not work.\nAny traffic to <code class=\"language-text\">localhost</code> is not recorded by\ntsung-recorder. What is the reason?</p>\n<details>\n<summary>\nClick to see why\n</summary>\n<p>A proxy server might not be on the same machine\n(not <code class=\"language-text\">localhost</code>). Then forwarding traffic to the host\n<code class=\"language-text\">localhost</code>, which is DNS resolved on the remote machine\nmeans we are not sending traffic to the web app on our machine.</p>\n</details>\n<h3 id=\"bypassing-chromes-localhost-no-proxy-policy\" style=\"position:relative;\"><a href=\"#bypassing-chromes-localhost-no-proxy-policy\" aria-label=\"bypassing chromes localhost no proxy policy permalink\" class=\"gatsby-remark-autolink-headers-a-tags before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Bypassing Chrome’s <code class=\"language-text\">localhost</code> No Proxy Policy</h3>\n<p>Turns out, Chrome (and Firefox) has a policy where if\nthe host is <code class=\"language-text\">localhost</code>, the browser will not use the proxy.\nInstead, it directly send the request to the port without\npassing it the proxy. Can you think of why?</p>\n<p>A way for us to bypass that is to alias the address <code class=\"language-text\">127.0.0.1</code>\nwith another domain name. We modify the <code class=\"language-text\">/etc/hosts</code> file.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">127.0.0.1   my.fake.domain.com</code></pre></div>\n<p>By adding the line in the <code class=\"language-text\">/etc/hosts</code> file, we can now access\nour application at <code class=\"language-text\">my.fake.domain.com:3000</code>.\nAnd since we are no longer using the host name <code class=\"language-text\">localhost</code> to\naccess our web app, the traffic are being forwarded to the\nproxy server (tsung recorder). Therefore, all your traffic\nis now recorded!</p>\n<p>To simulate a file upload, you simply do what your user do.\nNavigate to your web app (with the fake domain), and use\nthe web UI to upload the file. We can than go to <code class=\"language-text\">~/.tsung</code>\nto see the output XML file. For a POST request with file\nupload, you might find</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>request</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>http</span> <span class=\"token attr-name\">url</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">'</span>/items<span class=\"token punctuation\">'</span></span> <span class=\"token attr-name\">version</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">'</span>1.1<span class=\"token punctuation\">'</span></span>  <span class=\"token attr-name\">contents_from_file</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">'</span>/Users/galenw/.tsung/tsung_recorder20191121-2355-1.bin<span class=\"token punctuation\">'</span></span> <span class=\"token attr-name\">content_type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">'</span>multipart/form-data; boundary=----WebKitFormBoundaryZePexFw6eX9E0kPZ<span class=\"token punctuation\">'</span></span> <span class=\"token attr-name\">method</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">'</span>POST<span class=\"token punctuation\">'</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>http_header</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">'</span>Accept<span class=\"token punctuation\">'</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">'</span>text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3<span class=\"token punctuation\">'</span></span> <span class=\"token punctuation\">/></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>http_header</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">'</span>Accept-Encoding<span class=\"token punctuation\">'</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">'</span>gzip, deflate<span class=\"token punctuation\">'</span></span> <span class=\"token punctuation\">/></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>http_header</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">'</span>Accept-Language<span class=\"token punctuation\">'</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">'</span>en-GB,en;q=0.9,en-US;q=0.8,zh-CN;q=0.7,zh;q=0.6,zh-TW;q=0.5<span class=\"token punctuation\">'</span></span> <span class=\"token punctuation\">/></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>http_header</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">'</span>Cache-Control<span class=\"token punctuation\">'</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">'</span>max-age=0<span class=\"token punctuation\">'</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>http</span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>request</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>The most important thing to see here is the <code class=\"language-text\">http</code> tag.\nIt has attribute <code class=\"language-text\">content_type</code> being <code class=\"language-text\">multipart/form-data</code>,\nand <code class=\"language-text\">contents_from_file</code> referencing some binary file with\nthe extension <code class=\"language-text\">.bin</code>.\nIf you read the binary file, you will see it is the body\nof our POST request. Now, you have captured a POST request\nwith file upload. Then, you can use this in your test script\nwith no problem!</p>\n<h2 id=\"gotchas-in-test-script\" style=\"position:relative;\"><a href=\"#gotchas-in-test-script\" aria-label=\"gotchas in test script permalink\" class=\"gatsby-remark-autolink-headers-a-tags before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Gotchas in Test Script</h2>\n<p>Very likely that your test script uses some sort of dynamic\ndata, such as user id that depends on the previous request.\nThen, you will use\n<a href=\"http://tsung.erlang-projects.org/user_manual/conf-advanced-features.html#dynamic-substitutions\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">dynamic variable substitution</a>\nto solve the issue. This is done by turning substitution\non in the <code class=\"language-text\">request</code> tag.</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>request</span> <span class=\"token attr-name\">subst</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>However, during my testing, my test script gives error,\nfor reason related to memory overflow. The reason is that\nTsung is trying to go through the entire content of the\nbinary file to look for substitution pattern.\nThis requires way too much memory. To avoid that problem,\nyou can set <code class=\"language-text\">subst</code> option to ignore the body of the request.</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>request</span> <span class=\"token attr-name\">subst</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>all_except_body<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>Do not forget to undo your proxy setting and remove the\nalias from your <code class=\"language-text\">/etc/hosts</code> file after you are done!</p>","frontmatter":{"date":"2019-11-22","title":"All about Tsung and Its Proxy recorder","subtitle":"And How the Hell Did I Get It to Work?"},"timeToRead":8}},"pageContext":{"slug":"/2019-11-22-all-about-tsung/","prev":{"title":"Kotlin Learning Notes","path":"/blog/2019-12-31-learning-kotlin/"},"next":{"title":"How to randomly permutate an Array? Part 1","path":"/blog/2019-09-25-random-arr-0/"}}}}