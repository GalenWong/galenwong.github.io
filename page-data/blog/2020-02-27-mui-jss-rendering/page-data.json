{
    "componentChunkName": "component---src-templates-blog-template-blog-template-tsx",
    "path": "/blog/2020-02-27-mui-jss-rendering/",
    "result": {"data":{"markdownRemark":{"html":"<blockquote>\n<p>TLDR: you should move your theme provider into its\nown plugin. <a href=\"#conclusion-finally-mastering-the-jutsu\">Jump to the resolution</a>.</p>\n</blockquote>\n<p>This blog is built with Gatsby, as I have explained\nin <a href=\"/blog/2019-09-11-first-blog\">my earlier blog post</a>.\nTo handle the styling, I chose <a href=\"https://material-ui.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Material-UI</a>\n(MUI). I chose it since I like the <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>NiCe leVEl of AbStRacTiOn</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{NiCe leVEl of AbStRacTiOn}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord text\"><span class=\"mord\">NiCe leVEl of AbStRacTiOn</span></span></span></span></span></span>\nit offers to manage style changes within JavaScript. In\nits implementation, it uses <a href=\"https://cssinjs.org/react-jss/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">JSS</a>\nto support the feature. It ensures that the theme of\nthe website is more unified by using a theme object, which\nis a React context that runs through the entire React\nvirtual DOM tree to allow all components to access the theme\nand create styling that is coherent with the overall design.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ThemeProvider</span></span> <span class=\"token attr-name\">theme</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>myCustomTheme<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n  </span><span class=\"token punctuation\">{</span><span class=\"token comment\">/* the rest of the entire website... */</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">ThemeProvider</span></span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>Another perk with Material-UI is that although the CSS\nare now being controlled in JavaScript, which is suppose\nto make style rendering on the server side difficult,\nthe library supports SSR (server side rendering) of\nstyles straight out of the box. It ideally should work\nreally well with Gatsby. To enable SSR of MUI styling,\nwe add the helper plugin</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// gatsby-config.js</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  plugins<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">gatsby-plugin-material-ui</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>When it comes to dealing with components that is shared\nacross all pages, we will ideally want to adhere to the\n<a href=\"https://en.wikipedia.org/wiki/Don%27t_repeat_yourself\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">DRY principle</a>\nby not having to wrap all pages that we code with the\n<code class=\"language-text\">ThemeProvider</code> component.\nGatsby offers a nice way for us to factor out the\ncommon components from each pages through the\n<code class=\"language-text\">gatsby-browser.js</code> and <code class=\"language-text\">gatsby-ssr.js</code> file.\nWe can implement the <code class=\"language-text\">wrapRootComponent</code> function\nas such</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// gatsby-browser.js / gatsby-ssr.js</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">wrapRootElement</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> element <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n\t<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ThemeProvider</span></span> <span class=\"token attr-name\">theme</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>myCustomTheme<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n\t\t</span><span class=\"token punctuation\">{</span>element<span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n\t</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">ThemeProvider</span></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>As explained in the <a href=\"https://www.gatsbyjs.org/docs/browser-apis/#wrapRootElement\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">docs</a>,\n“this is useful to set up any Provider components\nthat will wrap your application.” This is\nexactly what we want. Now, we can sit tight and enjoy\nthe easy MUI SSR benefit. Right?</p>\n<h2 id=\"problem-with-ssr-ing-of-mui-theme\" style=\"position:relative;\"><a href=\"#problem-with-ssr-ing-of-mui-theme\" aria-label=\"problem with ssr ing of mui theme permalink\" class=\"gatsby-remark-autolink-headers-a-tags before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Problem with SSR-ing of MUI Theme</h2>\n<p>Not so fast, in early iteration of this website,\nwe find the following bug in the production build\n(generated from the command <code class=\"language-text\">gatsby build</code>).\nThe following gif shows how the old version of\nmy blog renders under a 6x CPU slowdown:</p>\n<figure align=center>\n<p><img src=\"/8d946af880f691b57f468d7f05879159/fouc.gif\" alt=\"Flash of Unstyled Content\"></p>\n<figcaption>\n<p><em>Initial rendering under 6x CPU slowdown</em></p>\n</figcaption>\n</figure>\n<p>The issue here is the flash of font.\nIn CSS, we call this flash of unstyled content (FOUC).\nMultiple factors can lead to FOUC. Common causes are\nloading of external CSS stylesheets and external fonts.\nIn my website, I use external fonts from Google Fonts.\nHowever, I only slowed down my CPU in the test and did\nnot toggle with the network throttle setting at all.\nThere might be something else that is causing the issue.</p>\n<p>The font of the titles are controlled by the MUI theme.\nThe next idea that I had is to check whether my CSS in\nMaterial UI is being properly SSR-ed. To do so, we prevent\nJavaScript from running. The reason to disable JS is that\nif style is properly SSR-ed, we should still see the font\nbeing loaded properly after some delay. However, if\nstyle is not SSR-ed, we will not even see the correct font\nat all. Since Javascript cannot be executed, the font style\ncannot be mounted into CSS in run time.</p>\n<blockquote>\n<p>To disable JavaScript, you can</p>\n</blockquote>\n<p>open Chrome DevTools, and hit\n<kbd>Cmd</kbd>+<kbd>Shift</kbd>+<kbd>P</kbd>\n(<kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>P</kbd> on Windows).\nThis will open a command dialog and search for the option\n<em>Disable JavaScript</em>.</p>\n<p>After disabling JavaScript, we re-render the page. This is\nthe result of rendering without JavaScript.</p>\n<figure align=center>\n<p><img src=\"/c00d089660069ea228509a0c6245dc21/fouc-no-js.gif\" alt=\"rendering without JavaScript\"></p>\n<figcaption>\n<p><em>Initial rendering with JavaScript disabled</em></p>\n</figcaption>\n</figure>\n<figure align=center>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 640px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e500d45c0c6e41eef0d56e84aa8d0a8e/09b15/render-compare.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 88.125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAABYlAAAWJQFJUiTwAAACvklEQVQ4y4VUCY7bOBCc3++r8oIFAiwmGY8teyxR1n2Q4k3qqAVpO+NxEERAoVtUq1RiNftFWwfjrlDGQBsbIbQBVxraGDjnMM8L/DzDzTO08xEhX9cVy7LEaK3FSzcytMOIbqS4UI5qkqBKg0qNTqhIHgh77VEIg9HO4G7GZD20X/B4hbqXPSmxzy7YZQV29YD3ZsQgFGbvI3xQby1IVSPJcnykGVrGUQkDbn0k2rbtk5BQiQtTyJlEPnJUTKCZJPobqXUuFqbDhPd6wI+ixVs9IukYOmmwPRMuNyXPMarzPhbFPVw3uHXDsiHm67ZhWbfffzmnAvUkQUaBcpK4UIGSybh2JwwqhZuh/HXvhPMQt8hM+Nj6SRh+YVd2eK96nJox5gHB5UeF7z3Ha8MiQr7vBf6rKTIqsTwS5nmOsihQVSXS8xmEELRtGx8+Ep4ygl1yvMZDEvFjn0BKeTXmTqi1hgkwBkpKWGOwhH57IgzrxuiYh7or0RYc+WqKsg7aWihjEXJ1a2x/I7rjz9cT4aGbcOo5PgaOYz8h6Sccew7lPLZ1jSqDKTnXOFGFQlh8UIUzUzGKh+aOhEle4JiXOF1KkLrFuawR1i51g65rIYSAcz4a9prXeCUV9mWLXdHGPKlacM6hlLoS7t7e0DYNhr7H0Heg4wA+MTBKQSmNhUHlYb8HydJbbagb4zt916HrOjDGYt3VlDAUtIlqQh4Oe8C8LL9OStt1oIzBeQ8pFcTN3d8aOxTcEadJ2DN7beZ19sC6/MWUp6N3bAZcxgmkZzg1A7KBgYz8qmqS+Jc08QMV17hMCq00MYb7nKl4Wr4oTLMMGSFI0xSHJIlNHZRiW/CdNPjn2/c4E9O8wOGc4pgR/DwkOJwzKL/ALetXws891NGAEMOgjAjNHky5N7MQEXyaIPgEbGtsrfuADab8DwKXZudTKcdDAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"rendering comparison: with and without JS\"\n        title=\"rendering comparison: with and without JS\"\n        src=\"/static/e500d45c0c6e41eef0d56e84aa8d0a8e/6af66/render-compare.png\"\n        srcset=\"/static/e500d45c0c6e41eef0d56e84aa8d0a8e/69538/render-compare.png 160w,\n/static/e500d45c0c6e41eef0d56e84aa8d0a8e/72799/render-compare.png 320w,\n/static/e500d45c0c6e41eef0d56e84aa8d0a8e/6af66/render-compare.png 640w,\n/static/e500d45c0c6e41eef0d56e84aa8d0a8e/d9199/render-compare.png 960w,\n/static/e500d45c0c6e41eef0d56e84aa8d0a8e/21b4d/render-compare.png 1280w,\n/static/e500d45c0c6e41eef0d56e84aa8d0a8e/09b15/render-compare.png 1704w\"\n        sizes=\"(max-width: 640px) 100vw, 640px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<figcaption>\n<p><em>Left: Rendering with JS, Right: Rendering with JS disabled</em></p>\n</figcaption>\n</figure>\n<p>We see that the font is not correctly being loaded.\nThe navbar is using the default system font.\nBy inspecting the CSS properties on the navbar,\nwe see that Material-UI font styling is not SSR-ed.</p>\n<p>What is going on here? Is the MUI plugin broken such\nthat it is not rendering the styling? When MUI renders\nthe styles, it injects the CSS into a <code class=\"language-text\">style</code> tag in the\n<code class=\"language-text\">head</code> tag, with the ID <code class=\"language-text\">jss-server-side</code>.\nHowever, this <code class=\"language-text\">style</code> tag will be unmounted as soon\nas the JavaScript runs since we want the JavaScript\nstyling to determine the actual styling. It is\nthere to prevent the FOUC problem between the webpage\nloads and when JavaScript runs.\nAfter checking, the <code class=\"language-text\">jss-server-side</code> style is there.\nTherefore, MUI should be able render the CSS properly.</p>\n<blockquote>\n<p>Note that this behavior can only be found in production\nbuild, in which a static website is generated. This behavior\ncannot be replicated in development mode. If we disable\nJavaScript in development, we cannot access our site\ndue to the fact that our site is hosted in a webpack\ndev server which requires JavaScript to run and\naccess the site.</p>\n</blockquote>\n<h2 id=\"how-the-official-mui-gatsby-example-handles-theme\" style=\"position:relative;\"><a href=\"#how-the-official-mui-gatsby-example-handles-theme\" aria-label=\"how the official mui gatsby example handles theme permalink\" class=\"gatsby-remark-autolink-headers-a-tags before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How the Official MUI Gatsby Example Handles Theme</h2>\n<p>I decided to check out the official MUI Gatsby example\nto see how they handled global theme styling.\nWe can find the example <a href=\"https://github.com/mui-org/material-ui/tree/master/examples/gatsby\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">here</a>.\nInterestingly, we see that they have written a custom\nplugin (<code class=\"language-text\">gatsby-plugin-top-layout</code>) to support theme injection.\nInside the plugin, we find a implementation of <code class=\"language-text\">wrapRootElement</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> TopLayout <span class=\"token keyword\">from</span> <span class=\"token string\">'./TopLayout'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">wrapRootElement</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> element <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">TopLayout</span></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>element<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">TopLayout</span></span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>In side <code class=\"language-text\">TopLayout.js</code>, we see that it wraps the children\nwithin a <code class=\"language-text\">ThemeProvider</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ThemeProvider</span></span> <span class=\"token attr-name\">theme</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>theme<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n  </span><span class=\"token punctuation\">{</span><span class=\"token comment\">/* CssBaseline kickstart an elegant, consistent, and simple baseline to build upon. */</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">CssBaseline</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n  </span><span class=\"token punctuation\">{</span>props<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">ThemeProvider</span></span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>This simply means that we are moving the theme wrapper\nfrom our root <code class=\"language-text\">gatsby-browser.js</code> into a plugin.\nWhen we try building the page (remember to build the\npage not in development mode), the styling works\nfine with the theme styling correctly injected.\nHowever, why does this matter?</p>\n<p>To understand the reason, we take a look at the order\nof plugins specified in the <code class=\"language-text\">gatsby-config.js</code> file for\nthe example repo.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  plugins<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">'gatsby-plugin-top-layout'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'gatsby-plugin-material-ui'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'gatsby-plugin-react-helmet'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  siteMetadata<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    title<span class=\"token operator\">:</span> <span class=\"token string\">'My page'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Interestingly, we see that the plugin that wraps\nour page in a theme provider (<code class=\"language-text\">gatsby-plugin-top-layout</code>)\ngoes before the plugin that actually does the SSR\nof style (<code class=\"language-text\">gatsby-plugin-material-ui</code>).\nWhat happens if you switch the order of plugin and\nhave <code class=\"language-text\">gatsby-plugin-top-layout</code> goes after?</p>\n<figure align=center>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 640px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/45bff268db82fc77b853a3bfdfc64a4c/169e3/mui-eg-compare.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 88.125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAABYlAAAWJQFJUiTwAAABXElEQVQ4y+1Ty26DMBDk//8McmgORQo0h3JpFAEhwjbgV6baTRehlqCo6rErjTBee3bGayfOWhC8c7DWYpomOOcY9E9wzs9zBO89r6NcCGGG9wHJe1XhNc9RlCU+TifkeY7j8YiqqlAUBQ6HA2/uug5pmiLLMryVJa/b7XYwxkDidrsh0XZCNxi0RmMK/isROSmguFwuSLMUaZbhZb9nRaQ2xjiT0TihhEzcZUd4L2M/2xmtRasVatWj0QprwQqv1yuapkHbthjHEdoEKBPYptaaLTGxD4ikggrH+3lZF/lLecKskAZEMAwDN2gcByZf2qFcXdc4n89cXBuLro8wg4UxGn3fM2kiZ0SbxeKyIoXYlsJKKS5IhcXBbFk2bYUQyiYpKJAcWxaFy65+7/CScCt+EK51bU3ho8K/Jny07p/wjwiXr+GZa/N0l5+92FvBL0We1BbkNTxSJyCFn6C4iD1slkIPAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"MUI Gatsby example comparison\"\n        title=\"MUI Gatsby example comparison\"\n        src=\"/static/45bff268db82fc77b853a3bfdfc64a4c/6af66/mui-eg-compare.png\"\n        srcset=\"/static/45bff268db82fc77b853a3bfdfc64a4c/69538/mui-eg-compare.png 160w,\n/static/45bff268db82fc77b853a3bfdfc64a4c/72799/mui-eg-compare.png 320w,\n/static/45bff268db82fc77b853a3bfdfc64a4c/6af66/mui-eg-compare.png 640w,\n/static/45bff268db82fc77b853a3bfdfc64a4c/d9199/mui-eg-compare.png 960w,\n/static/45bff268db82fc77b853a3bfdfc64a4c/21b4d/mui-eg-compare.png 1280w,\n/static/45bff268db82fc77b853a3bfdfc64a4c/169e3/mui-eg-compare.png 1682w\"\n        sizes=\"(max-width: 640px) 100vw, 640px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<figcaption>\n<p><em>Left: Built with <code class=\"language-text\">top-layout</code> before (correct behavior).</em><br>\n<em>Right: Built with <code class=\"language-text\">top-layout</code> after (incorrect behavior)</em><br>\nBoth rendered with JavaScript disabled.</p>\n</figcaption>\n</figure>\n<blockquote>\n<p>The exact steps taken to reproduce the buggy behavior:</p>\n<ol>\n<li>Clone the Gatsby MUI example (don’t forget <code class=\"language-text\">npm install</code>)</li>\n<li>Switch the order of <code class=\"language-text\">top-layout</code> and <code class=\"language-text\">material-ui</code> plugin</li>\n<li><code class=\"language-text\">gatsby build</code></li>\n<li><code class=\"language-text\">gatsby serve</code> and navigate to the page with JavaScript disabled.</li>\n</ol>\n</blockquote>\n<p>Ha! The ordering of plugins does matter here.\nThe order of plugin specified within the <code class=\"language-text\">gatsby-config</code>\nfile is the order in which Gatsby executes the\nplugin during the build stage.\nTherefore, the order of how the components are\nwrapped are also determined by this ordering.\nLet’s assume that we have the following ordering of plugins.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  plugins<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">'gatsby-plugin-1'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'gatsby-plugin-2'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'gatsby-plugin-3'</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Let us also assume that all of them implements the\n<code class=\"language-text\">wrapRootElement</code> API and wraps some components\naround the element. The order of how the components\nare wrapped is like the following:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">RootWrapper</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Plugin3Wrapper</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Plugin2Wrapper</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Plugin1Wrapper</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token punctuation\">{</span>children<span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Plugin1Wrapper</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Plugin2Wrapper</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Plugin3Wrapper</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">RootWrapper</span></span><span class=\"token punctuation\">></span></span></code></pre></div>\n<blockquote>\n<p>Note that the <code class=\"language-text\">RootWrapper</code> is the wrapper component\nspecified on the top level <code class=\"language-text\">gatsby-browser.js</code>.</p>\n</blockquote>\n<p>If the the material UI plugin comes first, we will have\nthe following structure.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ThemeProvider</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">MuiSsrPlugin</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token punctuation\">{</span>children<span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">MuiSsrPlugin</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">ThemeProvider</span></span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>The <code class=\"language-text\">MuiSsrPlugin</code> (hypothetical name) is the component\nthat takes the descendant nodes to render their style\nand inject them into the html build. However, since\nthe <code class=\"language-text\">ThemeProvider</code> is not a child of the <code class=\"language-text\">MuiSsrPlugin</code>,\nwhatever styling that it contains will not be rendered\non the static build.</p>\n<p>In our case, since the root wrapper is the last thing that\nwraps the entire React DOM tree, the <code class=\"language-text\">MuiSsrPlugin</code> can\nnever render its style correctly!</p>\n<h2 id=\"conclusion-finally-mastering-the-jutsu\" style=\"position:relative;\"><a href=\"#conclusion-finally-mastering-the-jutsu\" aria-label=\"conclusion finally mastering the jutsu permalink\" class=\"gatsby-remark-autolink-headers-a-tags before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion: Finally Mastering the Jutsu</h2>\n<blockquote>\n<h3> \n<p>Me: <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">O</mi><mi mathvariant=\"script\">m</mi><mi mathvariant=\"script\">a</mi><mi mathvariant=\"script\">e</mi><mtext> </mtext><mi mathvariant=\"script\">w</mi><mi mathvariant=\"script\">a</mi><mtext> </mtext><mi mathvariant=\"script\">m</mi><mi mathvariant=\"script\">o</mi><mi mathvariant=\"script\">u</mi><mtext> </mtext><mi mathvariant=\"script\">s</mi><mi mathvariant=\"script\">h</mi><mi mathvariant=\"script\">i</mi><mi mathvariant=\"script\">n</mi><mi mathvariant=\"script\">d</mi><mi mathvariant=\"script\">e</mi><mi mathvariant=\"script\">i</mi><mi mathvariant=\"script\">r</mi><mi mathvariant=\"script\">u</mi></mrow><annotation encoding=\"application/x-tex\">\\mathcal{Omae\\ wa\\ mou\\ shindeiru}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mord mathnormal\">ma</span><span class=\"mord mathnormal\">e</span><span class=\"mspace\"> </span><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"mord mathnormal\">a</span><span class=\"mspace\"> </span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">u</span><span class=\"mspace\"> </span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">hin</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">u</span></span></span></span></span></span><br>\nBug: <span class=\"math math-inline\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi mathvariant=\"script\">N</mi><mi mathvariant=\"script\">A</mi><mi mathvariant=\"script\">N</mi><mi mathvariant=\"script\">I</mi><mo stretchy=\"false\">?</mo></mrow><annotation encoding=\"application/x-tex\">\\mathcal{NANI?}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord\"><span class=\"mord mathcal\" style=\"margin-right:0.14736em;\">N</span><span class=\"mord mathcal\">A</span><span class=\"mord mathcal\" style=\"margin-right:0.14736em;\">N</span><span class=\"mord mathcal\" style=\"margin-right:0.07382em;\">I</span><span class=\"mclose\">?</span></span></span></span></span></span></p>\n</h3>\n<p>Meme reference: <a href=\"https://www.youtube.com/watch?v=dNQs_Bef_V8\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://www.youtube.com/watch?v=dNQs_Bef_V8</a></p>\n</blockquote>\n<p>To conclude, the main reasons that SSR does not\nwork in the website are:</p>\n<ol>\n<li>The <code class=\"language-text\">MuiSsrPlugin</code> only SSR styles of its descendant nodes</li>\n<li>The <code class=\"language-text\">wrapRootElement</code> in the top level <code class=\"language-text\">gatsby-browser</code> is always\nexecuted last.</li>\n</ol>\n<p>Again, to re-iterate, the most important take away here\nis that the order of plugin specified in <code class=\"language-text\">gatsby-config</code>\nis the order in which they execute. The solution is that\nwe extract our theme into a custom plugin. To see\nhow I implemented that, you can check out this commit:\n<a href=\"https://github.com/GalenWong/galenwong.github.io/commit/226fff203d3a67ac8d813ed3df9cd1f6f0bdb7df\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">226fff20</a>.</p>\n<p>At this point, you might ask “Why does this matter?\nCan’t we just live with that flash of styling? We still\nhave to bare with the flash of font styling since we\nultimately have to wait for the download of font assets.”</p>\n<p>Yes, it does not matter that much. But I simply enjoy\nfiguring things out and fixing this tiny but hard problem\nis very much beneficial to my understanding of Gatsby as\na whole. There are also practical benefits. With fonts,\nbrowser can cache them easily and the flash of font is\nonly a problem for first-time visitors. When visitors come\nback for a second time, browser does not need to wait for\nfont downloading and the flash will not be there. However,\nwith JavaScript styling, browser cannot cache the result and\ntherefore requires re-rendering every time the website is\nloaded. On low end device with slow CPU, this can be a problem\nsince initial rendering is already slow with the need to\nrun the React code, and building the React DOM tree again.</p>\n<p>To learn more about React rendering and front end optimization\nin general, read another blog post that I wrote for\nJavaScript Chat with ACM Hack:\n<a href=\"https://hack.uclaacm.com/posts/fall2019/js-chats-4/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Optimizing Frontend and React Apps</a>.</p>","frontmatter":{"date":"2020-02-27","title":"The Pitfall of Material UI Theme with Gatsby","subtitle":"The Order of Nesting Matters"},"timeToRead":9}},"pageContext":{"slug":"/2020-02-27-mui-jss-rendering/","prev":{"title":"台灣音樂的反思——香港與粵語文化的輸出","path":"/blog/2020-03-24-香港文化輸出/"},"next":{"title":"Nesterov Momentum Equivalence Derivation","path":"/blog/2020-02-08-nesterov-momentum-equivalence/"}}},
    "staticQueryHashes": ["1827841","1979163989"]}